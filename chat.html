<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revenue Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config={theme:{extend:{colors:{'p-bg':'#030303','p-panel':'#0A0A0A','p-card':'#0F0F0F','p-lime':'#CDFF00','p-lime2':'#B8E600','p-grey':'#888','p-greyL':'#A0A0A0','p-bdr':'#1A1A1A','p-bdr2':'#2A2A2A'},fontFamily:{sans:['Inter','system-ui'],mono:['JetBrains Mono','monospace']}}}}
    </script>
    <style>
        *{box-sizing:border-box}html,body{height:100%;margin:0;padding:0}
        body{background:#030303;color:#fff;display:flex;flex-direction:column;overflow:hidden}
        /* Scrollbar */
        .scr::-webkit-scrollbar{width:6px}.scr::-webkit-scrollbar-track{background:transparent}.scr::-webkit-scrollbar-thumb{background:#2A2A2A;border-radius:3px}
        /* Markdown prose */
        .prose{font-size:.9375rem;line-height:1.7}.prose p{margin-bottom:1em;color:#E0E0E0}.prose p:last-child{margin-bottom:0}.prose strong{color:#fff;font-weight:600}.prose em{color:#B0B0B0}
        .prose ul,.prose ol{padding-left:1.5em;margin:1em 0;color:#C0C0C0}.prose li{margin-bottom:.5em}.prose li::marker{color:#CDFF00}
        .prose a{color:#CDFF00;text-decoration:underline}.prose a:hover{color:#fff}
        .prose code{background:#1A1A1A;padding:.2em .4em;border-radius:4px;font-size:.85em}
        .prose h1,.prose h2,.prose h3{color:#fff;font-weight:600;margin:1.2em 0 .6em}.prose h1{font-size:1.4em}.prose h2{font-size:1.2em}.prose h3{font-size:1.05em}
        .prose blockquote{border-left:3px solid #CDFF00;padding-left:1em;margin:1em 0;color:#A0A0A0;font-style:italic}
        .prose hr{border:none;border-top:1px solid #2A2A2A;margin:1.5em 0}
        .prose table{width:100%;border-collapse:collapse;margin:1em 0;font-size:.85em}
        .prose th{text-align:left;padding:6px 10px;border-bottom:2px solid #333;color:#CDFF00;font-weight:600}
        .prose td{padding:5px 10px;border-bottom:1px solid #1A1A1A;color:#C0C0C0}
        /* Animations */
        @keyframes mi{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}.mi{animation:mi .4s cubic-bezier(.16,1,.3,1) forwards}
        @keyframes td{0%,60%,100%{opacity:.3}30%{opacity:1}}.td{animation:td 1.4s infinite;width:6px;height:6px;background:#CDFF00;border-radius:50%}.td:nth-child(2){animation-delay:.15s}.td:nth-child(3){animation-delay:.3s}
        /* Phase dots */
        .dot{width:10px;height:10px;border-radius:50%;border:2px solid #333;transition:all .3s ease}.dot.on{background:#22c55e;border-color:#22c55e}.dot.now{background:#CDFF00;border-color:#CDFF00;box-shadow:0 0 8px rgba(205,255,0,.4)}.dot.off{background:transparent}
        .ln{height:2px;width:20px;transition:background .3s}.ln.on{background:#22c55e}.ln.now{background:linear-gradient(90deg,#22c55e,#CDFF00)}.ln.off{background:#1A1A1A}
        /* Collapsible options */
        .opts-toggle{display:flex;align-items:center;justify-content:space-between;width:100%;padding:10px 16px;background:#0F0F0F;border:1px solid #1A1A1A;border-radius:12px;cursor:pointer;transition:all .2s ease;user-select:none}
        .opts-toggle:hover{border-color:rgba(205,255,0,.3);background:#141414}
        .opts-toggle .chevron{transition:transform .25s ease}
        .opts-toggle.open .chevron{transform:rotate(180deg)}
        .opts-body{max-height:0;overflow:hidden;transition:max-height .3s ease, opacity .25s ease;opacity:0}
        .opts-body.open{opacity:1}
        /* Mobile tweaks */
        @media(max-width:640px){
            .prose{font-size:.875rem;line-height:1.6}
            .phase-labels{display:none!important}
        }
        /* Go-back button */
        .back-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;font-size:13px;color:#888;background:transparent;border:1px solid transparent;border-radius:10px;cursor:pointer;transition:all .2s ease;user-select:none}
        .back-btn:hover{color:#CDFF00;border-color:rgba(205,255,0,.2);background:rgba(205,255,0,.04)}
        .back-btn svg{transition:transform .2s ease}
        .back-btn:hover svg{transform:translateX(-3px)}
        /* Instructions modal */
        .instr-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s ease}
        .instr-overlay.open{opacity:1;pointer-events:auto}
        .instr-panel{background:#0A0A0A;border:1px solid #1A1A1A;border-radius:20px;width:100%;max-width:620px;max-height:85vh;overflow-y:auto;position:relative;transform:translateY(20px) scale(.97);transition:transform .3s cubic-bezier(.16,1,.3,1);box-shadow:0 32px 80px rgba(0,0,0,.6)}
        .instr-overlay.open .instr-panel{transform:translateY(0) scale(1)}
        .instr-panel::-webkit-scrollbar{width:5px}.instr-panel::-webkit-scrollbar-track{background:transparent}.instr-panel::-webkit-scrollbar-thumb{background:#2A2A2A;border-radius:3px}
        .instr-panel h3{color:#fff;font-size:1rem;font-weight:600;margin:1.1em 0 .4em}.instr-panel h3:first-of-type{margin-top:0}
        .instr-panel p,.instr-panel li{color:#C0C0C0;font-size:.875rem;line-height:1.65}
        .instr-panel ul{list-style:disc;padding-left:1.4em;margin:.4em 0 1em}
        .instr-panel li{margin-bottom:.35em}
        .instr-panel li::marker{color:#CDFF00}
        .instr-panel strong{color:#fff;font-weight:600}
        .instr-panel a{color:#CDFF00;text-decoration:underline}
        .instr-panel a:hover{color:#fff}
        .instr-panel .tag{display:inline-block;background:rgba(205,255,0,.1);color:#CDFF00;font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.05em}
        .instr-btn{display:flex;align-items:center;gap:5px;padding:6px 10px;font-size:12px;color:#888;background:transparent;border:1px solid transparent;border-radius:8px;cursor:pointer;transition:all .2s ease;user-select:none}
        .instr-btn:hover{color:#CDFF00;border-color:rgba(205,255,0,.2);background:rgba(205,255,0,.04)}
    </style>
    <script src="auth-check.js"></script>
</head>
<body class="selection:bg-p-lime selection:text-black">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-4 transition-opacity duration-400">
        <div class="bg-p-card border border-p-bdr w-full max-w-lg rounded-2xl shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-p-lime/5 blur-[80px] rounded-full pointer-events-none"></div>
            <div class="relative z-10 p-6 sm:p-8">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 bg-p-lime/10 border border-p-lime/30 rounded-xl flex items-center justify-center text-p-lime shrink-0">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5"/></svg>
                    </div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold mb-1">Revenue Architect</h2>
                        <p class="text-p-grey text-sm">AI-powered B2B revenue diagnostic. Provide your digital footprint to begin.</p>
                    </div>
                </div>
                <form id="form" onsubmit="init(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-p-greyL uppercase tracking-wider mb-2">Company Website <span class="text-red-400">*</span></label>
                        <input type="url" id="f-web" required placeholder="https://yourcompany.com" class="w-full bg-p-panel border border-p-bdr rounded-xl px-4 py-3.5 text-white text-sm focus:border-p-lime focus:outline-none placeholder:text-gray-600 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-p-greyL uppercase tracking-wider mb-2">Business Description <span class="text-p-lime text-[10px] ml-1">IMPORTANT</span></label>
                        <textarea id="f-desc" rows="2" placeholder="What you sell, who you sell to, how you make money..." class="w-full bg-p-panel border border-p-bdr rounded-xl px-4 py-3.5 text-white text-sm focus:border-p-lime focus:outline-none placeholder:text-gray-600 resize-none transition-colors"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-p-greyL uppercase tracking-wider mb-2">Company Stage <span class="text-red-400">*</span></label>
                        <select id="f-stage" required class="w-full bg-p-panel border border-p-bdr rounded-xl px-4 py-3.5 text-white text-sm focus:border-p-lime focus:outline-none transition-colors appearance-none cursor-pointer" style='background-image:url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 fill=%27%23888%27 viewBox=%270 0 16 16%27%3E%3Cpath d=%27M8 11L3 6h10z%27/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center'>
                            <option value="" disabled selected class="text-gray-600">Select your stage</option>
                            <option value="pre_seed">Pre-Seed / Idea</option>
                            <option value="seed">Seed / Startup</option>
                            <option value="early_scale">Early Scale</option>
                            <option value="expansion">Expansion / Enterprise</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-p-greyL uppercase tracking-wider mb-2">Your LinkedIn Profile <span class="text-p-grey text-[10px]">OPTIONAL</span></label>
                        <input type="url" id="f-li" placeholder="https://linkedin.com/in/yourname" class="w-full bg-p-panel border border-p-bdr rounded-xl px-4 py-3.5 text-white text-sm focus:border-p-lime focus:outline-none placeholder:text-gray-600 transition-colors">
                    </div>
                    <button type="submit" id="f-btn" class="w-full bg-p-lime text-black font-bold py-4 rounded-xl hover:bg-p-lime2 transition-all shadow-[0_0_40px_rgba(205,255,0,.15)] flex items-center justify-center gap-2 mt-2">
                        <span>Start Diagnostic</span>
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INSTRUCTIONS OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="instrOverlay" class="instr-overlay" onclick="if(event.target===this)toggleInstructions()">
        <div class="instr-panel">
            <div class="sticky top-0 bg-[#0A0A0A] z-10 flex items-center justify-between px-6 pt-5 pb-3 border-b border-p-bdr">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-p-lime/10 border border-p-lime/30 rounded-xl flex items-center justify-center text-p-lime shrink-0">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" d="M12 16v.01M12 12a2 2 0 10-2-2"/></svg>
                    </div>
                    <span class="font-semibold text-sm">How to Use the GTM Clarity Agents</span>
                </div>
                <button onclick="toggleInstructions()" class="text-p-grey hover:text-white p-1.5 rounded-lg hover:bg-white/5 transition">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-1">
                <h3>1. Open the Panoramica Website</h3>
                <p>Go to: <a href="https://panoramica-website-1.vercel.app/" target="_blank">https://panoramica-website-1.vercel.app/</a></p>
                <p>For the best experience, <strong>use a PC</strong> rather than a phone.</p>

                <h3>2. Enter the Password</h3>
                <p style="font-family:'JetBrains Mono',monospace;background:#141414;border:1px solid #1A1A1A;padding:8px 14px;border-radius:10px;color:#CDFF00;font-size:.8rem;margin:.5em 0;user-select:all">PanoramicaSolutionsLolloGiulio2026</p>

                <h3>3. Start the Guided Session</h3>
                <ul>
                    <li>Look for the <strong>"Start Here"</strong> button on the homepage.</li>
                    <li>Click it to launch the interactive GTM Clarity session.</li>
                </ul>

                <h3>4. How the Session Works</h3>
                <p>The guided flow will:</p>
                <ul>
                    <li>Ask questions about your company, client, or GTM situation</li>
                    <li>Help you clarify where your biggest opportunities and bottlenecks are</li>
                    <li>Use your inputs to shape a personalized GTM strategy</li>
                    <li>Produce a <strong>90&#8209;day roadmap</strong> at the end</li>
                </ul>
                <p>The full experience takes around <strong>20 minutes</strong>.</p>

                <h3>5. How to Get the Best Results</h3>
                <p>You can interact in two ways:</p>

                <div style="display:flex;gap:10px;margin:.8em 0 .2em;flex-wrap:wrap">
                    <div style="flex:1;min-width:200px;background:#0F0F0F;border:1px solid #1A1A1A;border-radius:12px;padding:14px">
                        <p style="margin:0 0 4px"><strong>Option A &#8212; Use the Buttons</strong></p>
                        <p style="margin:0;font-size:.8rem;color:#999">Quick and easy, but less detailed.</p>
                    </div>
                    <div style="flex:1;min-width:200px;background:#0F0F0F;border:1px solid rgba(205,255,0,.25);border-radius:12px;padding:14px">
                        <p style="margin:0 0 4px"><strong>Option B &#8212; Add Context Manually</strong> <span class="tag">Recommended</span></p>
                        <p style="margin:0;font-size:.8rem;color:#999">Typing your own context produces much higher&#8209;quality insights and a more accurate roadmap. This is the method that unlocks the real value of the agents.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="h-14 border-b border-p-bdr bg-p-bg/90 backdrop-blur-md flex items-center justify-between px-4 md:px-6 z-40 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-2 h-7 bg-p-lime rounded-full"></div>
            <div>
                <h1 class="font-bold text-sm tracking-wide">REVENUE ARCHITECT</h1>
                <span id="st" class="text-[10px] text-p-grey font-mono">READY</span>
            </div>
            <!-- Phase tracker -->
            <div id="ph" class="hidden md:flex items-center ml-4 pl-4 border-l border-p-bdr gap-0.5">
                <div class="flex flex-col items-center"><div id="d0" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">INIT</span></div>
                <div id="l1" class="ln off mx-0.5"></div>
                <div class="flex flex-col items-center"><div id="d1" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">CO</span></div>
                <div id="l2" class="ln off mx-0.5"></div>
                <div class="flex flex-col items-center"><div id="d2" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">GTM</span></div>
                <div id="l3" class="ln off mx-0.5"></div>
                <div class="flex flex-col items-center"><div id="d3" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">SALES</span></div>
                <div id="l4" class="ln off mx-0.5"></div>
                <div class="flex flex-col items-center"><div id="d4" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">DX</span></div>
                <div id="l5" class="ln off mx-0.5"></div>
                <div class="flex flex-col items-center"><div id="d5" class="dot off"></div><span class="phase-labels text-[7px] text-p-grey mt-0.5 font-mono">âœ“</span></div>
                <div class="ml-3 pl-3 border-l border-p-bdr">
                    <span id="conf" class="text-xs font-mono text-p-lime">0%</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="tn" class="text-[10px] font-mono text-p-grey"></span>
            <button onclick="toggleInstructions()" class="instr-btn" title="How to use">
                <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" d="M12 16v.01M12 12a2 2 0 10-2-2"/></svg>
                <span class="hidden sm:inline">Guide</span>
            </button>
            <button onclick="confirmReset()" class="text-xs text-p-grey hover:text-white border border-p-bdr px-3 py-1.5 rounded-lg hover:bg-white/5 transition">Reset</button>
        </div>
    </header>
    <div class="w-full h-[2px] bg-p-panel"><div id="bar" class="h-full bg-gradient-to-r from-p-lime to-p-lime2 transition-all duration-700" style="width:0%"></div></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main id="chat" class="flex-1 overflow-y-auto scr scroll-smooth">
        <div class="max-w-3xl mx-auto py-6 px-4 md:px-0 min-h-full flex flex-col justify-end">
            <div id="msgs" class="space-y-5"></div>
            <div class="h-32"></div>
        </div>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTROLS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="shrink-0 bg-gradient-to-t from-p-bg via-p-bg/95 to-transparent pt-10 pb-5 px-4 z-30">
        <div class="max-w-3xl mx-auto space-y-3">
            <div id="opts" class="flex flex-col gap-2"></div>
            <!-- File attachments preview -->
            <div id="attachments-preview" class="hidden space-y-2"></div>
            <div id="inp" class="hidden opacity-0 transition-opacity duration-300">
                <div class="bg-p-card border border-p-bdr rounded-xl flex items-center p-2 focus-within:border-p-lime/50 transition-all">
                    <input type="file" id="file-input" class="hidden" multiple accept="image/*,.pdf,.doc,.docx,.txt,.csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                    <button onclick="$('file-input').click()" class="p-2.5 text-p-grey hover:text-p-lime transition-all shrink-0" title="Allega documento o immagine">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13"/></svg>
                    </button>
                    <input type="text" id="ti" class="flex-1 bg-transparent border-none text-white text-sm px-3 focus:ring-0 focus:outline-none placeholder:text-gray-600 h-10" placeholder="Type your response...">
                    <button onclick="sendText()" id="send-btn" class="p-2.5 bg-p-lime text-black rounded-lg hover:bg-p-lime2 transition-all shrink-0">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
                    </button>
                </div>
            </div>
            <p class="text-center text-[10px] text-gray-700 font-mono tracking-widest pt-1">PANORAMICA v12.0</p>
        </div>
    </div>

    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API = "/api/chat";
    const RAPI = "/api/report";

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let H = [];           // Conversation history for API
    let S = null;         // Session data from server
    let busy = false;     // Lock to prevent double-sends
    let diag = {};        // Initial diagnostic data (website, desc, linkedin)
    let lastMD = '';      // Last report markdown for re-download
    let lastDashboardData = null; // Dashboard data for 90-day tracker
    let attachedFiles = []; // Files to be sent with next message
    let stateStack = [];      // Stack for go-back functionality
    let currentDisplay = null; // Current displayed response data

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DOM HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const $ = id => document.getElementById(id);
    const chat = $('chat'), msgs = $('msgs'), opts = $('opts'), inp = $('inp'), ti = $('ti');

    function scroll() {
        requestAnimationFrame(() => {
            chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
        });
    }

    function confirmReset() {
        if (H.length > 2) {
            if (confirm('Reset the diagnostic? All progress will be lost.')) location.reload();
        } else {
            location.reload();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MESSAGE RENDERING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addU(text) {
        const d = document.createElement('div');
        d.className = 'flex gap-3 flex-row-reverse mi';
        d.innerHTML = `
            <div class="w-8 h-8 rounded-xl bg-p-lime flex items-center justify-center shrink-0">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-black">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                </svg>
            </div>
            <div class="max-w-[80%]">
                <div class="text-sm bg-p-panel border border-p-bdr p-3.5 rounded-2xl rounded-tr-md">${text.replace(/</g, '&lt;')}</div>
            </div>`;
        msgs.appendChild(d);
        scroll();
    }

    function addA(text) {
        if (!text) return;
        const d = document.createElement('div');
        d.className = 'flex gap-3 mi';
        let html;
        try {
            marked.setOptions({ breaks: true, gfm: true });
            html = marked.parse(text);
        } catch {
            html = text;
        }
        d.innerHTML = `
            <div class="w-8 h-8 rounded-xl bg-p-panel border border-p-bdr flex items-center justify-center shrink-0">
                <span class="text-p-lime font-mono text-[10px] font-bold">RA</span>
            </div>
            <div class="flex-1 max-w-[85%]">
                <div class="prose bg-p-card border border-p-bdr p-4 rounded-2xl rounded-tl-md">${html}</div>
            </div>`;
        msgs.appendChild(d);
        scroll();
    }

    function typing(on) {
        // Always remove existing typing indicator first
        const existing = $('typ');
        if (existing) existing.remove();

        if (on) {
            const d = document.createElement('div');
            d.id = 'typ';
            d.className = 'flex gap-3 mi';
            d.innerHTML = `
                <div class="w-8 h-8 rounded-xl bg-p-panel border border-p-bdr flex items-center justify-center shrink-0">
                    <span class="text-p-lime font-mono text-[10px] font-bold">RA</span>
                </div>
                <div class="flex gap-1.5 items-center bg-p-card border border-p-bdr px-5 py-3 rounded-2xl">
                    <div class="td"></div><div class="td"></div><div class="td"></div>
                </div>`;
            msgs.appendChild(d);
            scroll();
        }
    }

    function loading(text) {
        opts.innerHTML = `
            <div class="w-full bg-p-card border border-p-bdr p-4 rounded-xl flex items-center gap-3">
                <div class="w-4 h-4 border-2 border-p-lime border-t-transparent rounded-full animate-spin"></div>
                <span class="text-xs font-mono text-p-lime uppercase tracking-widest">${text}</span>
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE TRACKER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updPhase(phase, conf) {
        $('ph').classList.remove('hidden');
        const map = {
            welcome: 0, company: 1, gtm: 2, sales: 3,
            diagnosis: 4, pre_finish: 5, finish: 5,
            add_context: 4 // stays at diagnosis level
        };
        const idx = map[phase] ?? 0;

        for (let i = 0; i < 6; i++) {
            const d = $(`d${i}`);
            d.classList.remove('on', 'now', 'off');
            d.classList.add(i < idx ? 'on' : i === idx ? 'now' : 'off');
        }
        for (let i = 1; i <= 5; i++) {
            const l = $(`l${i}`);
            l.classList.remove('on', 'now', 'off');
            l.classList.add(i < idx ? 'on' : i === idx ? 'now' : 'off');
        }

        const pct = conf?.total || Math.round((idx / 5) * 100);
        $('bar').style.width = pct + '%';
        $('conf').textContent = pct + '%';
        $('tn').textContent = 'T' + (S?.turnCount || 0);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GO BACK FUNCTIONALITY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function saveStateBeforePick() {
        if (!currentDisplay) return;
        stateStack.push({
            H: JSON.parse(JSON.stringify(H)),
            S: S ? JSON.parse(JSON.stringify(S)) : null,
            msgCount: msgs.children.length,
            display: JSON.parse(JSON.stringify(currentDisplay))
        });
    }

    function goBack() {
        if (stateStack.length === 0 || busy) return;
        const prev = stateStack.pop();

        // Restore conversation state
        H = prev.H;
        S = prev.S;

        // Remove messages added since snapshot
        while (msgs.children.length > prev.msgCount) {
            msgs.removeChild(msgs.lastChild);
        }

        // Restore display
        currentDisplay = prev.display;
        updPhase(prev.display.current_phase, prev.display.confidence_state);
        showOpts(prev.display.options, prev.display.allowText);
        $('st').textContent = 'READY';
        scroll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPTIONS DISPLAY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showOpts(list, allowText) {
        opts.innerHTML = '';
        inp.classList.add('hidden', 'opacity-0');

        // Render go-back button if history exists
        if (stateStack.length > 0) {
            const backBtn = document.createElement('button');
            backBtn.className = 'back-btn mi';
            backBtn.onclick = goBack;
            backBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
                <span>Previous question</span>`;
            opts.appendChild(backBtn);
        }

        const items = list || [];
        // Separate primary (report/restart) buttons from regular options
        const primary = items.filter(o => o.key === 'generate_report' || o.key === 'update_and_generate' || o.key === 'restart' || o.key === 'download_again' || o.key === 'open_dashboard');
        const regular = items.filter(o => !primary.includes(o));

        // Render primary buttons directly (always visible)
        primary.forEach((o, i) => {
            const b = document.createElement('button');
            b.style.animationDelay = `${i * 0.06}s`;
            b.onclick = () => pick(o.key, o.label);
            if (o.key === 'generate_report' || o.key === 'update_and_generate') {
                b.className = 'mi w-full bg-p-lime text-black border-2 border-p-lime p-4 rounded-xl font-bold flex items-center justify-between hover:bg-p-lime2 hover:scale-[1.01] transition-all shadow-[0_0_30px_rgba(205,255,0,.15)]';
                b.innerHTML = `
                    <div class="flex items-center gap-3">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/>
                        </svg>
                        <span>${o.label}</span>
                    </div>
                    <span class="text-sm opacity-70">PDF</span>`;
            } else {
                b.className = 'mi w-full text-left bg-p-card border border-p-bdr hover:border-p-lime/50 p-3.5 rounded-xl transition-all group flex items-center justify-between';
                b.innerHTML = `
                    <span class="text-sm font-medium">${o.label}</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-p-grey group-hover:text-p-lime group-hover:translate-x-1 transition-all shrink-0 ml-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/>
                    </svg>`;
            }
            opts.appendChild(b);
        });

        // If there are regular options, wrap them in a collapsible accordion
        if (regular.length > 0) {
            const wrapper = document.createElement('div');
            wrapper.className = 'mi';

            // Toggle header
            const toggle = document.createElement('div');
            toggle.className = 'opts-toggle';
            toggle.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg width="16" height="16" fill="none" stroke="#CDFF00" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
                    <span class="text-sm font-medium text-white">${regular.length} option${regular.length > 1 ? 's' : ''} available</span>
                </div>
                <svg class="chevron" width="18" height="18" fill="none" stroke="#888" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
            `;

            // Body with buttons
            const body = document.createElement('div');
            body.className = 'opts-body';
            const inner = document.createElement('div');
            inner.className = 'flex flex-col gap-2 pt-2';

            regular.forEach((o, i) => {
                const b = document.createElement('button');
                b.style.animationDelay = `${i * 0.06}s`;
                b.onclick = () => pick(o.key, o.label);
                b.className = 'mi w-full text-left bg-p-card border border-p-bdr hover:border-p-lime/50 p-3.5 rounded-xl transition-all group flex items-center justify-between';
                b.innerHTML = `
                    <span class="text-sm font-medium">${o.label}</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" class="text-p-grey group-hover:text-p-lime group-hover:translate-x-1 transition-all shrink-0 ml-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/>
                    </svg>`;
                inner.appendChild(b);
            });

            body.appendChild(inner);
            wrapper.appendChild(toggle);
            wrapper.appendChild(body);
            opts.appendChild(wrapper);

            // Toggle click handler
            toggle.addEventListener('click', () => {
                const isOpen = body.classList.contains('open');
                if (isOpen) {
                    body.style.maxHeight = '0px';
                    body.classList.remove('open');
                    toggle.classList.remove('open');
                } else {
                    body.classList.add('open');
                    toggle.classList.add('open');
                    body.style.maxHeight = body.scrollHeight + 'px';
                    // Re-measure after animation frames settle
                    setTimeout(() => { if (body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }, 350);
                    scroll();
                }
            });
        }

        // Show text input if allowed
        if (allowText !== false) {
            inp.classList.remove('hidden');
            setTimeout(() => {
                inp.classList.remove('opacity-0');
                // Don't auto-focus on mobile (avoids keyboard popping up)
                if (window.innerWidth > 768) ti.focus();
            }, 150);
        }
        scroll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API CALL WITH RETRY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function api(body) {
        for (let attempt = 0; attempt < 3; attempt++) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 60000);
                const r = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: controller.signal
                });
                clearTimeout(timeout);
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return await r.json();
            } catch (e) {
                if (attempt === 2) throw e;
                await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PICK OPTION / SEND RESPONSE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function pick(key, label) {
        if (busy) return;

        // Handle special actions
        if (key === 'generate_report' || key === 'update_and_generate') { genPDF(); return; }
        if (key === 'restart') { location.reload(); return; }
        if (key === 'download_again') { genPDF(); return; }
        if (key === 'open_dashboard') { openDashboard(); return; }

        const stackLenBefore = stateStack.length;
        saveStateBeforePick();
        busy = true;
        addU(label || key);
        typing(true);
        loading('ANALYZING...');
        $('st').textContent = 'THINKING';

        try {
            const data = await api({
                choice: key,
                history: H,
                sessionData: S,
                contextData: diag
            });

            S = data.session_data;
            H.push(
                { role: 'user', content: key },
                { role: 'assistant', content: JSON.stringify(data) }
            );

            typing(false);
            updPhase(data.current_phase, data.confidence_state);
            addA(data.message);
            currentDisplay = {
                message: data.message,
                options: data.options,
                allowText: data.allow_text !== false && data.mode !== 'buttons',
                current_phase: data.current_phase,
                confidence_state: data.confidence_state
            };
            showOpts(data.options, data.allow_text !== false && data.mode !== 'buttons');
            $('st').textContent = 'READY';

        } catch (e) {
            if (stateStack.length > stackLenBefore) stateStack.pop();
            console.error('[pick error]', e);
            typing(false);
            $('st').textContent = 'ERROR';
            opts.innerHTML = `
                <div class="text-red-400 p-4 text-center bg-red-900/10 border border-red-900/50 rounded-xl space-y-2">
                    <p class="text-sm">Connection error: ${e.message}</p>
                    <button onclick="pick('${key.replace(/'/g, "\\'")}','${(label || key).replace(/'/g, "\\'")}')" class="bg-red-900/30 px-4 py-2 rounded-lg text-sm hover:bg-red-900/50 transition">Retry</button>
                </div>`;
        } finally {
            busy = false;
        }
    }

    function sendText() {
        const t = ti.value.trim();
        if (!t && attachedFiles.length === 0) return;
        if (busy) return;
        ti.value = '';
        
        // Send with attachments if any
        if (attachedFiles.length > 0) {
            pickWithFiles(t || 'Documento allegato', t || 'Documento allegato');
        } else {
            pick(t, t);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FILE ATTACHMENT HANDLING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        // Size limit: 10MB per file
        const maxSize = 10 * 1024 * 1024;
        for (const file of files) {
            if (file.size > maxSize) {
                alert(`File "${file.name}" Ã¨ troppo grande. Limite: 10MB`);
                e.target.value = '';
                return;
            }
        }

        // Convert files to base64
        try {
            for (const file of files) {
                const base64 = await fileToBase64(file);
                attachedFiles.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: base64
                });
            }
            updateAttachmentsPreview();
            e.target.value = ''; // Reset input
        } catch (err) {
            console.error('File read error:', err);
            alert('Errore durante la lettura dei file');
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function updateAttachmentsPreview() {
        const preview = $('attachments-preview');
        if (attachedFiles.length === 0) {
            preview.classList.add('hidden');
            return;
        }

        preview.classList.remove('hidden');
        preview.innerHTML = attachedFiles.map((f, i) => {
            const icon = f.type.startsWith('image/') ? 'ğŸ–¼ï¸' : 'ğŸ“„';
            const sizeKB = Math.round(f.size / 1024);
            return `
                <div class="bg-p-card border border-p-bdr rounded-lg p-2.5 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-lg">${icon}</span>
                        <div>
                            <div class="text-white font-medium text-xs">${f.name}</div>
                            <div class="text-p-grey text-[10px]">${sizeKB} KB</div>
                        </div>
                    </div>
                    <button onclick="removeAttachment(${i})" class="text-p-grey hover:text-red-400 transition-colors p-1">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    function removeAttachment(index) {
        attachedFiles.splice(index, 1);
        updateAttachmentsPreview();
    }

    async function pickWithFiles(key, label) {
        if (busy) return;
        const stackLenBefore = stateStack.length;
        saveStateBeforePick();
        busy = true;

        // Build user message with file info
        const fileInfo = attachedFiles.map(f => `[${f.name}]`).join(' ');
        const displayLabel = label + (attachedFiles.length > 0 ? ` ${fileInfo}` : '');
        
        addU(displayLabel);
        typing(true);
        loading('ANALYZING...');
        $('st').textContent = 'THINKING';

        try {
            const data = await api({
                choice: key,
                history: H,
                sessionData: S,
                contextData: diag,
                attachments: attachedFiles // Send files
            });

            // Clear attachments after sending
            attachedFiles = [];
            updateAttachmentsPreview();

            S = data.session_data;
            H.push(
                { role: 'user', content: key },
                { role: 'assistant', content: JSON.stringify(data) }
            );

            typing(false);
            updPhase(data.current_phase, data.confidence_state);
            addA(data.message);
            currentDisplay = {
                message: data.message,
                options: data.options,
                allowText: data.allow_text !== false && data.mode !== 'buttons',
                current_phase: data.current_phase,
                confidence_state: data.confidence_state
            };
            showOpts(data.options, data.allow_text !== false && data.mode !== 'buttons');
            $('st').textContent = 'READY';

        } catch (e) {
            if (stateStack.length > stackLenBefore) stateStack.pop();
            console.error('[pickWithFiles error]', e);
            typing(false);
            $('st').textContent = 'ERROR';
            opts.innerHTML = `
                <div class="text-red-400 p-4 text-center bg-red-900/10 border border-red-900/50 rounded-xl space-y-2">
                    <p class="text-sm">Connection error: ${e.message}</p>
                    <button onclick="pickWithFiles('${key.replace(/'/g, "\\'")}\'${(label || key).replace(/'/g, "\\'")}')" class="bg-red-900/30 px-4 py-2 rounded-lg text-sm hover:bg-red-900/50 transition">Retry</button>
                </div>`;
        } finally {
            busy = false;
        }
    }

    ti.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendText();
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function init(e) {
        e.preventDefault();

        const w = $('f-web').value.trim();
        const d = $('f-desc').value.trim();
        const l = $('f-li').value.trim();
        const s = $('f-stage').value;

        // Validate URL
        try { new URL(w); } catch { alert('Please enter a valid URL'); return; }
        if (!s) { alert('Please select your company stage'); return; }

        // Disable button
        $('f-btn').disabled = true;
        $('f-btn').innerHTML = '<div class="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div> <span>Scanning website...</span>';

        // Hide modal
        $('modal').style.opacity = '0';
        setTimeout(() => $('modal').classList.add('hidden'), 400);

        // Show initial state
        addA("**Initializing Revenue Architect** â€” Scanning your website and preparing the diagnostic...");
        loading('SCANNING WEBSITE...');
        $('st').textContent = 'SCANNING';

        diag = { website: w, description: d, linkedin: l, stage: s };

        try {
            const data = await api({
                choice: 'SNAPSHOT_INIT',
                history: [],
                contextData: diag,
                sessionData: null
            });

            S = data.session_data;
            H.push({ role: 'assistant', content: JSON.stringify(data) });

            updPhase(data.current_phase, data.confidence_state);
            addA(data.message);
            currentDisplay = {
                message: data.message,
                options: data.options,
                allowText: data.allow_text !== false && data.mode !== 'buttons',
                current_phase: data.current_phase,
                confidence_state: data.confidence_state
            };
            showOpts(data.options, data.allow_text !== false && data.mode !== 'buttons');
            $('st').textContent = 'READY';

        } catch (err) {
            console.error('[init error]', err);
            $('st').textContent = 'FAILED';
            opts.innerHTML = `
                <button onclick="location.reload()" class="w-full text-red-400 border border-red-900/50 bg-red-900/10 p-4 rounded-xl hover:bg-red-900/20 transition">
                    Failed to connect â€” click to retry
                </button>`;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PDF GENERATION â€” window.print() approach (reliable)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function genPDF() {
        if (busy) return;
        busy = true;
        loading('GENERATING STRATEGIC GROWTH PLAN...');
        $('st').textContent = 'GENERATING';

        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 120000);
            const r = await fetch(RAPI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: H,
                    sessionData: S,
                    diagnosticData: diag
                }),
                signal: controller.signal
            });
            clearTimeout(timeout);

            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();
            if (data.error) throw new Error(data.error);
            if (!data.report) throw new Error('Empty report received');

            lastMD = data.report;
            const chartData = data.chart_data || null;
            lastDashboardData = data.dashboard_data || null;
            loading('FORMATTING REPORT...');

            // Parse markdown to HTML
            marked.setOptions({ breaks: true, gfm: true, tables: true });
            const html = marked.parse(data.report);
            const company = S?.profile?.companyName || 'Company';
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const fullHTML = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Strategic Growth Plan â€” ${company}</title>
<style>
@media print {
    @page { margin: 15mm 12mm; size: A4; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .no-print { display: none !important; }
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Arial, Helvetica, sans-serif; font-size: 10.5pt; line-height: 1.5; color: #1a1a1a; background: #fff; }

/* Header */
.hdr { background: #111; color: #fff; padding: 35px; margin-bottom: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
.hdr .bar { width: 50px; height: 3px; background: #CDFF00; margin-bottom: 14px; }
.hdr h1 { font-size: 22pt; font-weight: 700; margin: 0 0 4px; letter-spacing: -0.5px; }
.hdr .sub { font-size: 11pt; color: #CDFF00; font-weight: 500; }
.hdr .meta { font-size: 8.5pt; color: #999; margin-top: 8px; }

/* Content */
.body { padding: 0 35px 35px; }
h1 { font-size: 16pt; font-weight: 700; margin: 24px 0 10px; padding-bottom: 4px; border-bottom: 2px solid #CDFF00; page-break-after: avoid; color: #111; }
h2 { font-size: 12.5pt; font-weight: 600; margin: 18px 0 8px; padding-bottom: 3px; border-bottom: 1px solid #ddd; page-break-after: avoid; color: #222; }
h3 { font-size: 11pt; font-weight: 600; margin: 14px 0 6px; page-break-after: avoid; color: #333; }
p { margin: 0 0 8px; }
strong { font-weight: 600; color: #000; }
em { font-style: italic; color: #555; }
ul, ol { margin: 6px 0 10px; padding-left: 20px; }
li { margin-bottom: 3px; }

/* Tables */
table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 9pt; page-break-inside: avoid; }
th { font-weight: 600; text-align: left; padding: 7px 8px; border: 1px solid #ddd; background: #f5f5f5; }
td { padding: 6px 8px; border: 1px solid #ddd; }
tr:nth-child(even) { background: #fafafa; }

blockquote { border-left: 3px solid #CDFF00; background: #f9f9f9; padding: 8px 12px; margin: 10px 0; font-style: italic; color: #555; }
hr { border: none; border-top: 1px solid #ddd; margin: 18px 0; }
a { color: #0066cc; }
code { background: #f0f0f0; padding: 1px 4px; border-radius: 3px; font-size: 9pt; }

/* Footer */
.ftr { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 8pt; color: #999; text-align: center; }

/* Charts section */
.charts-section { page-break-inside: avoid; margin: 24px 0 32px; padding: 20px 0; border-top: 2px solid #CDFF00; border-bottom: 1px solid #ddd; }
.charts-section h2 { font-size: 14pt; font-weight: 700; margin: 0 0 6px; color: #111; border: none; padding: 0; }
.charts-section .charts-sub { font-size: 9pt; color: #999; margin-bottom: 18px; }
.charts-grid { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; }
.chart-box { flex: 1; min-width: 280px; max-width: 440px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 16px; }
.chart-box h3 { font-size: 10pt; font-weight: 600; margin: 0 0 10px; color: #333; text-align: center; }
.chart-box canvas { width: 100% !important; }
.chart-box.chart-bar { min-height: 250px; }
.chart-legend { display: flex; gap: 16px; justify-content: center; margin-top: 12px; font-size: 8pt; color: #666; }
.chart-legend span { display: flex; align-items: center; gap: 4px; }
.chart-legend .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

/* Print button */
.print-bar { position: fixed; top: 0; left: 0; right: 0; background: #111; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
.print-bar span { color: #CDFF00; font-family: monospace; font-size: 12px; }
.print-bar button { background: #CDFF00; color: #000; border: none; padding: 8px 20px; font-weight: 700; cursor: pointer; border-radius: 6px; font-size: 13px; }
.print-bar button:hover { background: #B8E600; }
.print-spacer { height: 52px; }
</style></head><body>
<div class="print-bar no-print">
    <span>REVENUE ARCHITECT</span>
    <button onclick="window.print()">â¬‡ Save as PDF (Ctrl+P)</button>
</div>
<div class="print-spacer no-print"></div>
<div class="hdr">
    <div class="bar"></div>
    <h1>Strategic Growth Plan</h1>
    <div class="sub">${company}</div>
    <div class="meta">Revenue Architect by Panoramica &nbsp;|&nbsp; ${date} &nbsp;|&nbsp; Validated Market Audit &nbsp;|&nbsp; Confidential</div>
</div>
<div class="body">
${chartData ? `
<div class="charts-section">
  <h2>ğŸ“Š Benchmark Scorecard â€” Visual Overview</h2>
  <p class="charts-sub">Your metrics compared to ${chartData.stageLabel} stage benchmarks (KBCM, OpenView, Bessemer, Pavilion)</p>
  <div class="charts-grid">
    ${chartData.radar.labels.length >= 3 ? '<div class="chart-box"><h3>Performance Radar</h3><canvas id="radarChart"></canvas><div class="chart-legend"><span><span class="dot" style="background:#CDFF00"></span> Your Company</span><span><span class="dot" style="background:#888"></span> Stage Median</span></div></div>' : ''}
    <div class="chart-box chart-bar"><h3>Health Score by Metric</h3><canvas id="barChart"></canvas><div class="chart-legend"><span><span class="dot" style="background:#CDFF00"></span> Your Score</span><span><span class="dot" style="background:#D0D0D0"></span> Stage Median</span><span><span class="dot" style="background:rgba(34,197,94,0.3)"></span> Best-in-Class</span></div></div>
  </div>
</div>` : ''}
${html}</div>
<div class="ftr">
    <p>Generated by Revenue Architect by Panoramica â€” Validated Market Audit</p>
    <p style="font-size:7pt;color:#bbb;margin-top:4px">Benchmarks: KBCM SaaS Survey, Statista, Pavilion/BenchSights, OpenView, Bessemer Cloud Index</p>
</div>
${chartData ? `<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"><\/script>
<script>
(function(){
  const CD = ${JSON.stringify(chartData).replace(/<\//g, '<\\/')};
  if (!CD) return;

  // â”€â”€ Color palette â”€â”€
  const LIME = '#CDFF00';
  const LIME_A = 'rgba(205,255,0,0.25)';
  const GREY = '#888888';
  const GREY_A = 'rgba(136,136,136,0.15)';
  const GREEN = 'rgba(34,197,94,0.3)';
  const GREEN_BORDER = 'rgba(34,197,94,0.6)';

  // â”€â”€ Radar Chart â”€â”€
  const radarEl = document.getElementById('radarChart');
  if (radarEl && CD.radar.labels.length >= 3) {
    new Chart(radarEl, {
      type: 'radar',
      data: {
        labels: CD.radar.labels,
        datasets: [
          {
            label: 'Your Company',
            data: CD.radar.datasets.user,
            backgroundColor: LIME_A,
            borderColor: LIME,
            borderWidth: 2,
            pointBackgroundColor: LIME,
            pointBorderColor: '#111',
            pointRadius: 4,
            pointHoverRadius: 6
          },
          {
            label: 'Stage Median',
            data: CD.radar.datasets.median,
            backgroundColor: GREY_A,
            borderColor: GREY,
            borderWidth: 1.5,
            borderDash: [4, 4],
            pointBackgroundColor: GREY,
            pointBorderColor: '#fff',
            pointRadius: 3,
            pointHoverRadius: 5
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return ctx.dataset.label + ': ' + ctx.raw + '/100';
              }
            }
          }
        },
        scales: {
          r: {
            min: 0, max: 100,
            ticks: { stepSize: 25, font: { size: 8 }, backdropColor: 'transparent', color: '#999' },
            grid: { color: 'rgba(0,0,0,0.06)' },
            angleLines: { color: 'rgba(0,0,0,0.06)' },
            pointLabels: { font: { size: 9, weight: '500' }, color: '#333' }
          }
        }
      }
    });
  }

  // â”€â”€ Bar Chart (horizontal, normalized 0-100 scores) â”€â”€
  const barEl = document.getElementById('barChart');
  if (barEl && CD.bar.labels.length > 0) {
    // Build labels with units
    const barLabelsWithUnits = CD.bar.labels.map((l, i) => l + ' (' + CD.bar.units[i] + ')');

    new Chart(barEl, {
      type: 'bar',
      data: {
        labels: barLabelsWithUnits,
        datasets: [
          {
            label: 'Your Value',
            data: CD.bar.datasets.user.map(v => v !== null ? Math.max(0, Math.min(100, v)) : 0),
            backgroundColor: CD.bar.datasets.user.map(v => v !== null ? LIME : 'rgba(200,200,200,0.15)'),
            borderColor: CD.bar.datasets.user.map(v => v !== null ? LIME : 'rgba(200,200,200,0.3)'),
            borderWidth: 1,
            borderRadius: 3,
            barPercentage: 0.7,
            categoryPercentage: 0.8
          },
          {
            label: 'Stage Median',
            data: CD.bar.datasets.median.map(v => Math.max(0, Math.min(100, v || 0))),
            backgroundColor: '#D0D0D0',
            borderColor: '#B0B0B0',
            borderWidth: 1,
            borderRadius: 3,
            barPercentage: 0.7,
            categoryPercentage: 0.8
          },
          {
            label: 'Good Threshold',
            data: CD.bar.datasets.good.map(v => v !== null ? Math.max(0, Math.min(100, v)) : 0),
            backgroundColor: GREEN,
            borderColor: GREEN_BORDER,
            borderWidth: 1,
            borderRadius: 3,
            barPercentage: 0.7,
            categoryPercentage: 0.8
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const idx = ctx.dataIndex;
                const unit = CD.bar.units[idx] || '';
                const score = ctx.raw;
                if (ctx.dataset.label === 'Your Value') {
                  if (CD.bar.datasets.user[idx] === null) return 'Not disclosed';
                  const raw = CD.bar.rawUser ? CD.bar.rawUser[idx] : null;
                  return 'Your Score: ' + score + '/100' + (raw !== null ? ' (actual: ' + raw + ' ' + unit + ')' : '');
                }
                if (ctx.dataset.label === 'Stage Median') {
                  const raw = CD.bar.rawMedian ? CD.bar.rawMedian[idx] : null;
                  return 'Median Score: ' + score + '/100' + (raw !== null ? ' (actual: ' + raw + ' ' + unit + ')' : '');
                }
                return ctx.dataset.label + ': ' + score + '/100';
              }
            }
          }
        },
        scales: {
          x: {
            min: 0, max: 100,
            grid: { color: 'rgba(0,0,0,0.04)' },
            ticks: { font: { size: 8 }, color: '#999', callback: function(v) { return v + '%'; } },
            title: { display: true, text: 'Health Score (0 = critical, 100 = best-in-class)', font: { size: 8 }, color: '#999' }
          },
          y: {
            grid: { display: false },
            ticks: { font: { size: 8.5, weight: '500' }, color: '#333' }
          }
        }
      }
    });
    // Set explicit height based on metric count
    barEl.parentElement.style.height = Math.max(200, CD.bar.labels.length * 50 + 40) + 'px';
    barEl.style.height = '100%';
  }
})();
<\/script>` : ''}
</body></html>`;

            // Open in new window
            const w2 = window.open('', '_blank', 'width=900,height=1100');
            if (w2) {
                w2.document.write(fullHTML);
                w2.document.close();
            } else {
                // Popup blocked â€” download as HTML file
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const u = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = u;
                a.download = `Growth_Plan_${company.replace(/\s+/g, '_')}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(u);
            }

            addA("âœ… **Your Strategic Growth Plan is ready!**\n\nUse **Ctrl+P** (or Cmd+P on Mac) in the report window to save as PDF.\n\nThe report includes: strategic narrative (Current State â†’ Hard Truth â†’ Unlock â†’ Risk of Inaction), stage-calibrated benchmarks (KBCM, Statista, Pavilion), diagnostic findings with golden thread traceability, 90-day sequential roadmap with second-order effects, trade-off analysis, metrics dashboard, and stage-appropriate tool recommendations." + (lastDashboardData ? "\n\nğŸ“Š **Interactive Dashboard available** â€” track your metrics against the 90-day targets in real time." : ""));
            const postOpts = [
                { key: 'download_again', label: 'ğŸ“¥ Open Report Again' },
                { key: 'restart', label: 'Start New Diagnostic' }
            ];
            if (lastDashboardData) postOpts.splice(1, 0, { key: 'open_dashboard', label: 'ğŸ“Š Open 90-Day Dashboard' });
            showOpts(postOpts, false);
            updPhase('finish', { total: 100 });
            $('st').textContent = 'COMPLETE';

        } catch (e) {
            console.error('[genPDF error]', e);
            $('st').textContent = 'FAILED';
            opts.innerHTML = `
                <div class="text-red-400 p-4 text-center bg-red-900/10 border border-red-900/50 rounded-xl space-y-3">
                    <p class="text-sm">Report generation failed: ${e.message}</p>
                    <div class="flex gap-3 justify-center flex-wrap">
                        <button onclick="genPDF()" class="bg-red-900/30 px-4 py-2 rounded-lg text-sm hover:bg-red-900/50 transition">Retry</button>
                        ${lastMD ? '<button onclick="dlMD()" class="bg-p-bdr px-4 py-2 rounded-lg text-sm text-white hover:bg-p-bdr2 transition">Download as Markdown</button>' : ''}
                    </div>
                </div>`;
        } finally {
            busy = false;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INTERACTIVE 90-DAY DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openDashboard() {
        if (!lastDashboardData) return;
        const dd = lastDashboardData;
        const safeDD = JSON.stringify(dd).replace(/<\//g, '<\\/');
        const company = dd.companyName || 'Company';
        const storageKey = 'pano_dash_' + company.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();

        const dashHTML = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>90-Day Dashboard â€” ${company}</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"><\/script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--lime:#CDFF00;--lime2:#B8E600;--bg:#030303;--bg2:#0A0A0A;--card:#111;--bdr:#222;--grey:#888;--red:#ef4444;--green:#22c55e;--yellow:#eab308}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:#e5e5e5;min-height:100vh}

/* Header */
.dash-header{background:var(--bg2);border-bottom:1px solid var(--bdr);padding:20px 28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.dash-header h1{font-size:18px;font-weight:700;color:#fff;display:flex;align-items:center;gap:10px}
.dash-header h1 span{color:var(--lime);font-size:12px;font-weight:500;background:rgba(205,255,0,.1);padding:3px 10px;border-radius:20px;border:1px solid rgba(205,255,0,.2)}
.dash-meta{font-size:11px;color:var(--grey)}
.dash-actions{display:flex;gap:8px;flex-wrap:wrap}
.dash-actions button{background:var(--card);border:1px solid var(--bdr);color:#fff;padding:7px 14px;border-radius:8px;font-size:12px;cursor:pointer;transition:all .2s}
.dash-actions button:hover{border-color:var(--lime);color:var(--lime)}
.dash-actions button.primary{background:var(--lime);color:#000;border-color:var(--lime);font-weight:600}
.dash-actions button.primary:hover{background:var(--lime2)}

/* Week selector */
.week-bar{display:flex;align-items:center;gap:6px;padding:16px 28px;background:var(--bg2);border-bottom:1px solid var(--bdr);overflow-x:auto}
.week-bar label{font-size:11px;color:var(--grey);margin-right:6px;white-space:nowrap;font-weight:500}
.week-btn{background:var(--card);border:1px solid var(--bdr);color:var(--grey);padding:5px 12px;border-radius:6px;font-size:11px;cursor:pointer;transition:all .2s;white-space:nowrap}
.week-btn:hover{border-color:var(--lime);color:#fff}
.week-btn.active{background:var(--lime);color:#000;border-color:var(--lime);font-weight:600}
.week-btn.has-data{border-color:rgba(205,255,0,.4);color:var(--lime)}

/* Health Overview */
.health-row{display:flex;gap:16px;padding:20px 28px;flex-wrap:wrap}
.health-card{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:20px;flex:1;min-width:180px;text-align:center}
.health-card .h-label{font-size:11px;color:var(--grey);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.health-card .h-value{font-size:36px;font-weight:800;color:var(--lime)}
.health-card .h-sub{font-size:11px;color:var(--grey);margin-top:4px}
.health-card.negative .h-value{color:var(--red)}
.health-card.warning .h-value{color:var(--yellow)}

/* Metric grid */
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;padding:20px 28px}
.metric-card{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:18px;transition:border-color .2s}
.metric-card:hover{border-color:rgba(205,255,0,.3)}
.metric-card .mc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.metric-card .mc-label{font-size:13px;font-weight:600;color:#fff}
.metric-card .mc-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
.mc-badge.good{background:rgba(34,197,94,.15);color:var(--green)}
.mc-badge.warn{background:rgba(234,179,8,.15);color:var(--yellow)}
.mc-badge.bad{background:rgba(239,68,68,.15);color:var(--red)}
.metric-card .mc-values{display:flex;gap:16px;margin-bottom:14px;flex-wrap:wrap}
.mc-val{display:flex;flex-direction:column;gap:2px}
.mc-val .mv-label{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--grey)}
.mc-val .mv-num{font-size:15px;font-weight:700;color:#fff}
.mc-val .mv-num.lime{color:var(--lime)}
.mc-val .mv-num.green{color:var(--green)}
.mc-val .mv-num.dim{color:var(--grey)}

/* Progress bar */
.mc-progress{margin-bottom:10px}
.mc-progress .mp-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--grey);margin-bottom:4px}
.mp-track{height:6px;background:#1a1a1a;border-radius:3px;position:relative;overflow:visible}
.mp-fill{height:100%;border-radius:3px;transition:width .5s ease;position:relative}
.mp-median{position:absolute;top:-3px;width:2px;height:12px;background:var(--grey);border-radius:1px;z-index:2}
.mp-target{position:absolute;top:-3px;width:2px;height:12px;background:var(--lime);border-radius:1px;z-index:2;opacity:.6}

/* Editable input */
.mc-edit{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.05)}
.mc-edit label{font-size:10px;color:var(--grey);white-space:nowrap}
.mc-edit input{background:#0a0a0a;border:1px solid var(--bdr);color:#fff;padding:5px 10px;border-radius:6px;font-size:13px;font-weight:600;width:90px;text-align:right;outline:none;transition:border-color .2s}
.mc-edit input:focus{border-color:var(--lime)}
.mc-edit .mc-unit{font-size:11px;color:var(--grey)}
.mc-edit button{background:var(--lime);color:#000;border:none;padding:4px 10px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;transition:background .2s}
.mc-edit button:hover{background:var(--lime2)}

/* Trend arrow */
.trend-up{color:var(--green)}
.trend-down{color:var(--red)}
.trend-flat{color:var(--grey)}
.trend-icon{font-size:12px;margin-left:4px}

/* Charts section */
.chart-section{padding:20px 28px}
.chart-container{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:20px}
.chart-container h3{font-size:14px;font-weight:600;color:#fff;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.chart-container h3 span{font-size:10px;color:var(--grey);font-weight:400}
.chart-canvas-wrap{position:relative;height:300px}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--lime);color:#000;padding:10px 20px;border-radius:8px;font-size:12px;font-weight:600;opacity:0;transform:translateY(10px);transition:all .3s;z-index:999;pointer-events:none}
.toast.show{opacity:1;transform:translateY(0)}

/* Responsive */
@media(max-width:640px){
  .health-row{flex-direction:column}
  .metrics-grid{grid-template-columns:1fr}
  .dash-header{flex-direction:column;align-items:flex-start}
  .chart-canvas-wrap{height:220px}
}

/* Print */
@media print{
  body{background:#fff;color:#111}
  .dash-header,.week-bar{background:#fff;border-color:#ddd}
  .dash-header h1{color:#111}
  .health-card,.metric-card,.chart-container{background:#fff;border-color:#ddd}
  .mc-edit{display:none}
  .dash-actions{display:none}
}
</style></head><body>
<div class="dash-header">
  <div>
    <h1>90-Day Sprint Dashboard <span>${dd.stageLabel} Stage</span></h1>
    <div class="dash-meta">${company} &mdash; Generated ${new Date(dd.generatedAt).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})} &mdash; Revenue Architect by Panoramica</div>
  </div>
  <div class="dash-actions">
    <button onclick="exportJSON()" title="Download dashboard data">Export JSON</button>
    <button onclick="resetWeek()" title="Clear current week data">Reset Week</button>
    <button class="primary" onclick="saveAll()">Save Progress</button>
  </div>
</div>

<div class="week-bar" id="weekBar">
  <label>WEEK:</label>
</div>

<div class="health-row" id="healthRow"></div>

<div class="metrics-grid" id="metricsGrid"></div>

<div class="chart-section">
  <div class="chart-container">
    <h3>Metric Trajectory <span>(all tracked weeks)</span></h3>
    <div class="chart-canvas-wrap"><canvas id="trajChart"></canvas></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // â”€â”€ Bootstrap data â”€â”€
  const INIT = ${safeDD};
  const SKEY = '${storageKey}';
  const WEEKS = 13; // W0 (baseline) through W12

  // â”€â”€ State â”€â”€
  let currentWeek = 0;
  let history = {}; // { weekNum: { metricKey: value, ... } }
  let metrics = INIT.metrics.map(m => ({...m})); // mutable copy

  // â”€â”€ Load from localStorage â”€â”€
  function loadState() {
    try {
      const raw = localStorage.getItem(SKEY);
      if (raw) {
        const saved = JSON.parse(raw);
        if (saved.history) history = saved.history;
        // Find latest week with data
        const weeks = Object.keys(history).map(Number).sort((a,b) => a-b);
        currentWeek = weeks.length > 0 ? weeks[weeks.length - 1] : 0;
      }
    } catch(e) { console.warn('Load failed:', e); }
    // Ensure baseline (W0) is seeded from initial data
    if (!history['0']) {
      history['0'] = {};
      metrics.forEach(m => { history['0'][m.key] = m.current; });
    }
  }

  // â”€â”€ Save to localStorage â”€â”€
  function saveState() {
    try {
      localStorage.setItem(SKEY, JSON.stringify({
        companyName: INIT.companyName,
        stageLabel: INIT.stageLabel,
        generatedAt: INIT.generatedAt,
        metrics: INIT.metrics,
        history: history,
        lastSaved: new Date().toISOString()
      }));
    } catch(e) { console.warn('Save failed:', e); }
  }

  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }

  // â”€â”€ Health score for a value â”€â”€
  function calcHealth(m, val) {
    if (val === null || val === undefined) return null;
    let score;
    if (m.lowerBetter) {
      if (val <= m.good) score = 100;
      else if (val >= m.bad) score = 0;
      else score = Math.round(100 * (m.bad - val) / (m.bad - m.good));
    } else {
      if (val >= m.good) score = 100;
      else if (val <= m.bad) score = 0;
      else score = Math.round(100 * (val - m.bad) / (m.good - m.bad));
    }
    return Math.max(0, Math.min(100, score));
  }

  // â”€â”€ Progress percentage toward target â”€â”€
  function calcProgress(m, val) {
    if (val === null) return 0;
    const start = m.current; // baseline
    const target = m.target90Day;
    if (target === start) return 100;
    if (m.lowerBetter) {
      // start=5, target=2.6, val=3 => (5-3)/(5-2.6) = 83%
      if (val <= target) return 100;
      if (val >= start) return 0;
      return Math.round(100 * (start - val) / (start - target));
    } else {
      if (val >= target) return 100;
      if (val <= start) return 0;
      return Math.round(100 * (val - start) / (target - start));
    }
  }

  // â”€â”€ Get current value for a metric in selected week â”€â”€
  function getVal(metricKey) {
    // Walk backward from currentWeek to find latest entry
    for (let w = currentWeek; w >= 0; w--) {
      if (history[String(w)] && history[String(w)][metricKey] !== undefined) {
        return history[String(w)][metricKey];
      }
    }
    const m = metrics.find(x => x.key === metricKey);
    return m ? m.current : null;
  }

  // â”€â”€ Trend vs previous week â”€â”€
  function getTrend(m) {
    const curr = getVal(m.key);
    if (curr === null || currentWeek === 0) return 'flat';
    let prev = null;
    for (let w = currentWeek - 1; w >= 0; w--) {
      if (history[String(w)] && history[String(w)][m.key] !== undefined) {
        prev = history[String(w)][m.key];
        break;
      }
    }
    if (prev === null) return 'flat';
    const diff = curr - prev;
    if (Math.abs(diff) < 0.01) return 'flat';
    const improving = m.lowerBetter ? diff < 0 : diff > 0;
    return improving ? 'up' : 'down';
  }

  function trendIcon(trend) {
    if (trend === 'up') return '<span class="trend-icon trend-up">\\u25B2</span>';
    if (trend === 'down') return '<span class="trend-icon trend-down">\\u25BC</span>';
    return '<span class="trend-icon trend-flat">\\u25CF</span>';
  }

  // â”€â”€ Render week bar â”€â”€
  function renderWeekBar() {
    const bar = document.getElementById('weekBar');
    bar.innerHTML = '<label>WEEK:</label>';
    for (let w = 0; w < WEEKS; w++) {
      const btn = document.createElement('button');
      btn.className = 'week-btn' + (w === currentWeek ? ' active' : '') + (history[String(w)] ? ' has-data' : '');
      btn.textContent = w === 0 ? 'Baseline' : 'W' + w;
      btn.onclick = () => { currentWeek = w; renderAll(); };
      bar.appendChild(btn);
    }
  }

  // â”€â”€ Render health overview â”€â”€
  function renderHealth() {
    const row = document.getElementById('healthRow');
    // Overall health = avg of all metric health scores at current week
    let totalScore = 0, count = 0;
    metrics.forEach(m => {
      const val = getVal(m.key);
      const h = calcHealth(m, val);
      if (h !== null) { totalScore += h; count++; }
    });
    const avgHealth = count > 0 ? Math.round(totalScore / count) : 0;

    // Metrics on track (progress >= 50% at proportional week)
    const expectedProgress = currentWeek > 0 ? Math.round((currentWeek / 12) * 100) : 0;
    let onTrack = 0, total = metrics.length;
    metrics.forEach(m => {
      const val = getVal(m.key);
      const prog = calcProgress(m, val);
      if (prog >= expectedProgress || prog >= 100) onTrack++;
    });

    // Days remaining
    const daysRemaining = Math.max(0, (12 - currentWeek) * 7);

    const healthClass = avgHealth >= 70 ? '' : avgHealth >= 40 ? ' warning' : ' negative';
    row.innerHTML = \`
      <div class="health-card\${healthClass}">
        <div class="h-label">Overall Health</div>
        <div class="h-value">\${avgHealth}</div>
        <div class="h-sub">out of 100</div>
      </div>
      <div class="health-card">
        <div class="h-label">On Track</div>
        <div class="h-value" style="color:\${onTrack >= total * 0.6 ? 'var(--green)' : onTrack >= total * 0.3 ? 'var(--yellow)' : 'var(--red)'}">\${onTrack}/\${total}</div>
        <div class="h-sub">metrics meeting pace</div>
      </div>
      <div class="health-card">
        <div class="h-label">Sprint Week</div>
        <div class="h-value" style="color:#fff">\${currentWeek === 0 ? 'BL' : 'W' + currentWeek}</div>
        <div class="h-sub">\${daysRemaining} days remaining</div>
      </div>
      <div class="health-card">
        <div class="h-label">Expected Progress</div>
        <div class="h-value" style="color:#fff;font-size:28px">\${expectedProgress}%</div>
        <div class="h-sub">linear pace at week \${currentWeek}</div>
      </div>
    \`;
  }

  // â”€â”€ Render metric cards â”€â”€
  function renderMetrics() {
    const grid = document.getElementById('metricsGrid');
    grid.innerHTML = '';
    metrics.forEach(m => {
      const val = getVal(m.key);
      const health = calcHealth(m, val);
      const progress = calcProgress(m, val);
      const trend = getTrend(m);
      const badgeClass = health >= 70 ? 'good' : health >= 40 ? 'warn' : 'bad';
      const badgeLabel = health >= 70 ? 'Healthy' : health >= 40 ? 'At Risk' : 'Critical';

      // Progress bar fill color
      const fillColor = progress >= 80 ? 'var(--green)' : progress >= 40 ? 'var(--yellow)' : 'var(--red)';
      const fillWidth = Math.max(0, Math.min(100, progress));

      // Median marker position (relative to start â†’ target range for display)
      let medianPos = 50;
      if (m.target90Day !== m.current) {
        if (m.lowerBetter) {
          medianPos = Math.round(100 * (m.current - m.stageMedian) / (m.current - m.target90Day));
        } else {
          medianPos = Math.round(100 * (m.stageMedian - m.current) / (m.target90Day - m.current));
        }
        medianPos = Math.max(0, Math.min(100, medianPos));
      }

      const weekVal = (history[String(currentWeek)] && history[String(currentWeek)][m.key] !== undefined) ? history[String(currentWeek)][m.key] : '';

      const card = document.createElement('div');
      card.className = 'metric-card';
      card.innerHTML = \`
        <div class="mc-top">
          <div class="mc-label">\${m.label}\${trendIcon(trend)}</div>
          <div class="mc-badge \${badgeClass}">\${badgeLabel} (\${health})</div>
        </div>
        <div class="mc-values">
          <div class="mc-val"><span class="mv-label">Current</span><span class="mv-num lime">\${val !== null ? val : 'â€”'}\${val !== null ? m.unit : ''}</span></div>
          <div class="mc-val"><span class="mv-label">Baseline</span><span class="mv-num dim">\${m.current}\${m.unit}</span></div>
          <div class="mc-val"><span class="mv-label">Stage Median</span><span class="mv-num">\${m.stageMedian}\${m.unit}</span></div>
          <div class="mc-val"><span class="mv-label">90-Day Target</span><span class="mv-num green">\${m.target90Day}\${m.unit}</span></div>
        </div>
        <div class="mc-progress">
          <div class="mp-labels"><span>Baseline: \${m.current}\${m.unit}</span><span>Target: \${m.target90Day}\${m.unit}</span></div>
          <div class="mp-track">
            <div class="mp-fill" style="width:\${fillWidth}%;background:\${fillColor}"></div>
            <div class="mp-median" style="left:\${medianPos}%" title="Stage Median: \${m.stageMedian}\${m.unit}"></div>
          </div>
        </div>
        <div class="mc-edit">
          <label>W\${currentWeek} Value:</label>
          <input type="number" step="any" id="input_\${m.key}" value="\${weekVal}" placeholder="\${val !== null ? val : '...'}" />
          <span class="mc-unit">\${m.unit}</span>
          <button onclick="updateMetric('\${m.key}')">Update</button>
        </div>
      \`;
      grid.appendChild(card);
    });
  }

  // â”€â”€ Update a single metric for current week â”€â”€
  window.updateMetric = function(key) {
    const input = document.getElementById('input_' + key);
    if (!input) return;
    const raw = input.value.trim();
    if (raw === '') return;
    const val = parseFloat(raw);
    if (isNaN(val)) return;
    if (!history[String(currentWeek)]) history[String(currentWeek)] = {};
    history[String(currentWeek)][key] = val;
    saveState();
    renderAll();
    toast('Updated ' + (metrics.find(m => m.key === key)?.label || key));
  };

  // â”€â”€ Save all inputs for current week â”€â”€
  window.saveAll = function() {
    if (!history[String(currentWeek)]) history[String(currentWeek)] = {};
    let updated = 0;
    metrics.forEach(m => {
      const input = document.getElementById('input_' + m.key);
      if (input && input.value.trim() !== '') {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
          history[String(currentWeek)][m.key] = val;
          updated++;
        }
      }
    });
    saveState();
    renderAll();
    toast(updated > 0 ? 'Saved ' + updated + ' metrics for W' + currentWeek : 'No changes to save');
  };

  // â”€â”€ Reset current week â”€â”€
  window.resetWeek = function() {
    if (currentWeek === 0) { toast('Cannot reset baseline'); return; }
    if (!confirm('Clear all data for Week ' + currentWeek + '?')) return;
    delete history[String(currentWeek)];
    saveState();
    renderAll();
    toast('Week ' + currentWeek + ' cleared');
  };

  // â”€â”€ Export JSON â”€â”€
  window.exportJSON = function() {
    const blob = new Blob([JSON.stringify({
      companyName: INIT.companyName,
      stageLabel: INIT.stageLabel,
      generatedAt: INIT.generatedAt,
      exportedAt: new Date().toISOString(),
      metrics: INIT.metrics,
      history: history
    }, null, 2)], { type: 'application/json' });
    const u = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = u;
    a.download = 'Dashboard_' + INIT.companyName.replace(/\\s+/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(u);
  };

  // â”€â”€ Trajectory Chart â”€â”€
  let trajChartInstance = null;
  function renderChart() {
    const canvas = document.getElementById('trajChart');
    if (!canvas) return;
    if (trajChartInstance) { trajChartInstance.destroy(); trajChartInstance = null; }

    const weeksWithData = Object.keys(history).map(Number).sort((a,b) => a-b);
    if (weeksWithData.length < 1) return;

    const labels = weeksWithData.map(w => w === 0 ? 'Baseline' : 'W' + w);

    // Normalize each metric to 0-100 health score for fair comparison
    const COLORS = ['#CDFF00','#22c55e','#3b82f6','#a855f7','#ef4444','#eab308','#ec4899','#06b6d4'];
    const datasets = metrics.map((m, i) => {
      const data = weeksWithData.map(w => {
        let val = null;
        // Find value at or before this week
        for (let ww = w; ww >= 0; ww--) {
          if (history[String(ww)] && history[String(ww)][m.key] !== undefined) {
            val = history[String(ww)][m.key];
            break;
          }
        }
        return val !== null ? calcHealth(m, val) : null;
      });
      return {
        label: m.label,
        data: data,
        borderColor: COLORS[i % COLORS.length],
        backgroundColor: COLORS[i % COLORS.length] + '22',
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        tension: 0.3,
        spanGaps: true
      };
    });

    // Add target line (100 = all targets met)
    datasets.push({
      label: 'Target (100)',
      data: weeksWithData.map(() => 100),
      borderColor: 'rgba(205,255,0,0.2)',
      borderWidth: 1,
      borderDash: [6, 3],
      pointRadius: 0,
      fill: false
    });

    trajChartInstance = new Chart(canvas, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#aaa', font: { size: 10 }, boxWidth: 12, padding: 12, usePointStyle: true }
          },
          tooltip: {
            backgroundColor: '#111',
            titleColor: '#fff',
            bodyColor: '#ccc',
            borderColor: '#333',
            borderWidth: 1,
            callbacks: {
              label: function(ctx) {
                const m = metrics[ctx.datasetIndex];
                if (!m) return ctx.dataset.label + ': ' + ctx.parsed.y;
                const week = weeksWithData[ctx.dataIndex];
                const rawVal = getValAt(m.key, week);
                return m.label + ': ' + (ctx.parsed.y !== null ? ctx.parsed.y : 'â€”') + ' health' + (rawVal !== null ? ' (' + rawVal + m.unit + ')' : '');
              }
            }
          }
        },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', font: { size: 10 } } },
          y: {
            min: 0, max: 105,
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#888', font: { size: 10 }, callback: v => v + '%' },
            title: { display: true, text: 'Health Score', color: '#888', font: { size: 10 } }
          }
        }
      }
    });
  }

  // Helper: get raw value at specific week
  function getValAt(key, week) {
    for (let w = week; w >= 0; w--) {
      if (history[String(w)] && history[String(w)][key] !== undefined) {
        return history[String(w)][key];
      }
    }
    return null;
  }

  // â”€â”€ Render everything â”€â”€
  function renderAll() {
    renderWeekBar();
    renderHealth();
    renderMetrics();
    renderChart();
  }

  // â”€â”€ Init â”€â”€
  loadState();
  renderAll();
})();
<\/script>
</body></html>`;

        const w2 = window.open('', '_blank');
        if (w2) {
            w2.document.open();
            w2.document.write(dashHTML);
            w2.document.close();
        } else {
            const blob = new Blob([dashHTML], { type: 'text/html' });
            const u = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = u;
            a.download = `Dashboard_${company.replace(/\s+/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(u);
        }
    }

    function dlMD() {
        if (!lastMD) return;
        const blob = new Blob([lastMD], { type: 'text/markdown' });
        const u = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = u;
        a.download = `Growth_Plan_${S?.profile?.companyName?.replace(/\s+/g, '_') || 'Company'}.md`;
        a.click();
        URL.revokeObjectURL(u);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INSTRUCTIONS PANEL TOGGLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleInstructions() {
        const ov = $('instrOverlay');
        ov.classList.toggle('open');
    }
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && $('instrOverlay').classList.contains('open')) toggleInstructions();
    });

    // Warn before leaving
    window.addEventListener('beforeunload', e => {
        if (H.length > 2) { e.preventDefault(); e.returnValue = ''; }
    });
    </script>
</body>
</html>
